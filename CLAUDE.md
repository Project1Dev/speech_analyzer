# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Speech Mastery App is an iOS-based personal AI speech coach with server-backed analysis. It analyzes speech patterns to detect filler words, hedging, passive voice, and provides personalized feedback for communication improvement.

**Current Status**: Early prototype - infrastructure in place, most features are TODO stubs awaiting implementation.

**Architecture**: Client-server with iOS app (SwiftUI) + FastAPI backend + PostgreSQL database

## Development Commands

### Backend Development

```bash
# Start all services (PostgreSQL, Redis, FastAPI)
docker-compose up -d

# View logs
docker-compose logs -f backend

# Stop services
docker-compose down

# Run backend with hot reload (alternative to docker-compose)
cd backend
source venv/bin/activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Database migrations
cd backend
alembic upgrade head                              # Apply migrations
alembic revision --autogenerate -m "description"  # Create new migration

# Backend testing
cd backend
pytest                                    # Run all tests
pytest --cov=app --cov-report=html       # With coverage
pytest tests/test_api/test_analyze.py    # Specific test file
```

### iOS Development

```bash
# Generate Xcode project (required after cloning or project.yml changes)
cd ios
xcodegen generate

# Open in Xcode
open SpeechMastery.xcodeproj

# Command line build (for testing)
xcodebuild -scheme SpeechMastery -configuration Debug -sdk iphonesimulator build
```

**Important**: The `.xcodeproj` file is generated by XcodeGen and should NOT be committed to git. Always regenerate it after pulling changes.

### Utility Scripts

```bash
# Find backend IP for iOS app configuration (Linux VM)
cd backend
./show_api_url.sh

# Setup scripts (in scripts/ directory)
./scripts/setup.sh           # Initial setup
./scripts/start-docker.sh    # Start Docker services
./scripts/quick-start.sh     # Quick setup
```

## Dual-VM Development Setup

This project uses a **dual-VM development workflow**:

- **Linux VM**: Backend development (FastAPI, PostgreSQL, Docker)
- **macOS VM**: iOS app development (Xcode, Simulator)

Both VMs run on the same host machine and communicate via host networking.

### Why Dual-VM?

iOS builds via GitHub Actions were problematic (code signing, slow builds, cluttered commit history). Building iOS locally on macOS VM provides faster iteration, native tooling, and easier debugging.

### Development Workflow

**Typical cycle:**
1. **Linux VM**: Make backend changes, test with pytest
2. **Linux VM**: Commit and push to GitHub
3. **macOS VM**: Pull latest changes, regenerate Xcode project if needed
4. **macOS VM**: Build iOS app, test integration with backend
5. **macOS VM**: Commit iOS changes, push to GitHub
6. **Linux VM**: Pull if needed

### Network Configuration

**Backend accessibility from iOS app:**

1. **On Linux VM**: Docker services bind to `0.0.0.0` (see docker-compose.yml)
2. **Find Linux VM IP**: Run `cd backend && ./show_api_url.sh`
3. **Configure iOS app**: Update `ios/SpeechMastery/Utilities/Constants.swift` with Linux VM IP
4. **Test connectivity**: `curl http://<linux-vm-ip>:8000/health` from macOS VM

**Port requirements:**
- Port 8000: FastAPI backend
- Port 5432: PostgreSQL
- Port 6379: Redis
- Port 5050: pgAdmin (optional)

### Git Workflow Best Practices

- Commit frequently on each VM
- Use clear commit messages indicating component (e.g., "backend:", "ios:")
- Push after completing logical units of work
- Pull on other VM before starting new work
- Avoid editing same files simultaneously on both VMs

### CI/CD Strategy

- **Backend**: GitHub Actions runs pytest on push (`.github/workflows/test-backend.yml`)
- **iOS**: No CI/CD - built locally on macOS VM
- **Integration tests**: Manual testing between iOS app and backend

## Architecture Overview

### iOS App (MVVM Pattern)

Strict MVVM separation with **Data Flow**: View → ViewModel → Service → Storage/API

**Key components:**
- **Models** (`Models/`): Codable structs (Recording, AnalysisResult, Report)
- **Services** (`Services/`): Business logic layer
  - `APIService`: HTTP client for backend communication
  - `AudioRecordingService`: AVFoundation recording management
  - `AudioStorageService`: Local file persistence
  - `PrivacyManager`: Microphone permissions
  - `AutoDeletionService`: 7-day cleanup
  - `CacheService`: Local data caching
  - `NetworkMonitor`: Connection status
- **ViewModels** (`ViewModels/`): Bridge between Views and Services, expose @Published properties
- **Views** (`Views/`): SwiftUI components (RecordingView, AnalysisResultView, DailyReportView, etc.)
- **Utilities** (`Utilities/`): Constants and feature flags

**XcodeGen**: Project uses `project.yml` to generate `.xcodeproj`. The Xcode project file itself is gitignored and must be regenerated with `xcodegen generate` after cloning or modifying `project.yml`.

### Backend (Layered Architecture)

**Request Flow**: API Layer → Service Layer → AI Engines/Data Layer

- **API Layer** (`app/api/routes.py`): FastAPI routes, request validation (Pydantic), authentication
- **Service Layer** (`app/services/`):
  - `AnalysisEngine`: Orchestrates analysis pipeline (TODO: mostly stubs)
  - Analyzer Services: `PowerDynamicsAnalyzer`, `LinguisticAuthorityAnalyzer`, `VocalCommandAnalyzer`, `PersuasionAnalyzer` (TODO: skeleton implementations)
  - `TranscriptionService`: Abstract interface for speech-to-text (TODO)
  - NLP services (TODO)
- **Data Layer** (`app/models/`, `app/core/`): SQLAlchemy ORM, database connection pool, Alembic migrations
- **Schemas** (`app/schemas/`): Pydantic models for request/response validation

**Authentication**: Single-user prototype mode with hardcoded token `SINGLE_USER_DEV_TOKEN_12345`

### Analysis Pipeline (Planned)

```
Audio Upload → Save temp file → Transcribe → Parallel Analysis (4 analyzers)
→ Aggregate scores → Calculate critical moments → Store PostgreSQL → Return JSON
```

**Key Design**: AI services use abstract interfaces to allow easy swapping of implementations (Whisper, spaCy, etc.)

## Important Patterns and Conventions

### iOS Development

1. **MVVM Strict Separation**: Never bypass the ViewModel layer - Views should only bind to ViewModels
2. **Service Injection**: ViewModels receive services via initializer dependency injection
3. **Published State**: ViewModels use `@Published` for all UI-observable state
4. **Constants Configuration**: API endpoints and configuration in `Constants.swift` - must be updated for dual-VM setup

### Backend Development

1. **Layered Architecture**: Keep API, Service, and Data layers separate
2. **Dependency Injection**: Use FastAPI's Depends() for database sessions and services
3. **Pydantic Validation**: All request/response models use Pydantic schemas
4. **Abstract Interfaces**: Transcription and NLP services implement abstract base classes for swappability

### Adding a New Analyzer

1. Create class in `backend/app/services/` extending BaseAnalyzer (if implemented)
2. Register in AnalysisEngine
3. Add database columns via Alembic migration
4. Update Pydantic response schemas in `app/schemas/`
5. Create iOS display in appropriate ViewModel and View

### Adding an API Endpoint

1. Define Pydantic schemas in `app/schemas/`
2. Create endpoint in `app/api/routes.py`
3. Add tests in `backend/tests/test_api/`
4. Update `docs/API_CONTRACT.md`
5. Implement iOS APIService method
6. Create/update ViewModel and View

### Database Schema Changes

1. Edit SQLAlchemy models in `app/models/`
2. Run `alembic revision --autogenerate -m "description"`
3. Review generated migration in `alembic/versions/`
4. Apply with `alembic upgrade head`

## Environment Configuration

### Backend Environment Variables (`.env`)

Required in `backend/.env`:
- `DATABASE_URL`: PostgreSQL connection string
- `SINGLE_USER_TOKEN`: Auth token for prototype (default: `SINGLE_USER_DEV_TOKEN_12345`)
- `UPLOAD_DIR`: File storage location (default: `./uploads`)
- `TRANSCRIPTION_SERVICE`: Provider (mock/whisper/etc)
- `NLP_SERVICE`: Provider (mock/spacy/etc)

Optional feature flags:
- `ENABLE_CEO_VOICE`: Future premium feature
- `ENABLE_LIVE_GUARDIAN`: Future premium feature
- `ENABLE_SIMULATION_ARENA`: Future premium feature
- `ENABLE_GAMIFICATION`: Future premium feature

### iOS API Configuration

Edit `ios/SpeechMastery/Utilities/Constants.swift`:

```swift
enum API {
    // For dual-VM setup: use Linux VM IP
    static let baseURL = "http://192.168.1.XXX:8000"  // Replace with Linux VM IP

    // For single machine: use localhost
    // static let baseURL = "http://localhost:8000"

    static let authToken = "SINGLE_USER_DEV_TOKEN_12345"
}
```

Find Linux VM IP with `backend/show_api_url.sh`

## Database Schema

PostgreSQL with key tables:
- `users` - Single-user for prototype
- `recordings` - Audio file metadata
- `analysis_results` - Comprehensive speech analysis with JSONB patterns field
- `daily_reports` - Aggregated daily statistics

See `docs/DATABASE_SCHEMA.md` for complete schema.

## Testing Strategy

### Backend
- **Unit tests**: Individual analyzer functions (TODO: most not implemented)
- **Integration tests**: Full API endpoint flows (TODO)
- **Fixtures**: Sample audio, transcripts, expected outputs (TODO)
- **Coverage target**: 80%+ for core analysis logic

### iOS
- **Model tests**: Data structure validation (TODO)
- **Service tests**: Mock API responses (TODO)
- **ViewModel tests**: Business logic (TODO)
- **SwiftUI canvas**: Visual verification during development

## Current Implementation Status

**Completed Infrastructure:**
- ✅ Docker environment (docker-compose.yml)
- ✅ FastAPI app skeleton (app/main.py)
- ✅ Database models and migrations
- ✅ Pydantic schemas
- ✅ iOS MVVM structure
- ✅ iOS Services layer
- ✅ XcodeGen configuration

**TODO (Most Features):**
- ⚠️ Analyzer implementations (~130 TODOs in services)
- ⚠️ API endpoint implementations
- ⚠️ Transcription service integration
- ⚠️ NLP service integration
- ⚠️ iOS-backend integration
- ⚠️ Test coverage
- ⚠️ Error handling
- ⚠️ Logging infrastructure

## Premium Features (Future)

All marked as `OPTIONAL FEATURE` in comments - do not implement unless explicitly requested:
- CEO Voice Synthesis
- Live Guardian Mode (real-time analysis)
- Simulation Arena (roleplay practice)
- Gamification system
- Multi-user JWT authentication

These should integrate through existing architecture without major refactoring.

## Services and URLs

### Development Services
- Backend API: http://localhost:8000
- API Docs (Swagger): http://localhost:8000/docs
- API Docs (ReDoc): http://localhost:8000/redoc
- Health Check: http://localhost:8000/health
- Database: localhost:5432
- Redis: localhost:6379
- pgAdmin: http://localhost:5050 (admin@example.com / admin)

### API Authentication
All requests require header: `Authorization: Bearer SINGLE_USER_DEV_TOKEN_12345`

## Additional Documentation

- `README.md` - Project overview and quick start
- `docs/DEVELOPMENT_GUIDE.md` - Complete setup and workflow guide
- `docs/MACOS_VM_SETUP.md` - macOS VM setup for dual-VM workflow (comprehensive)
- `docs/ARCHITECTURE.md` - Detailed system architecture
- `docs/API_CONTRACT.md` - REST API specification
- `docs/DATABASE_SCHEMA.md` - Database schema details

## Troubleshooting

**iOS can't reach backend:**
- Check firewall on Linux VM: `sudo ufw status`
- Verify backend is running: `docker-compose ps`
- Check Linux VM IP hasn't changed: `backend/show_api_url.sh`
- Test with curl from macOS VM: `curl http://<ip>:8000/health`

**Xcode project issues:**
- Regenerate with `cd ios && xcodegen generate`
- Clean build folder in Xcode: Product → Clean Build Folder (Cmd+Shift+K)

**Database connection errors:**
- Verify PostgreSQL is running: `docker-compose ps postgres`
- Check logs: `docker-compose logs postgres`
- Restart: `docker-compose restart postgres`

**Git conflicts:**
- Usually happen when editing same files on both VMs
- Pull before starting work to minimize conflicts
- Use `git stash` if you need to pull with uncommitted changes
